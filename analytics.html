<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Analytics - AI Prod Weekly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Email Analytics Dashboard</h1>
            <p class="text-gray-600 mt-2">Track newsletter performance and subscriber engagement</p>
        </div>

        <!-- Date Range Filter -->
        <div class="bg-white rounded-xl border border-gray-200 p-4 mb-6">
            <div class="flex items-center gap-4 flex-wrap">
                <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-600">Period:</label>
                    <select id="period-select" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="all">All time</option>
                    </select>
                </div>
                <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Total Subscribers</p>
                        <p class="text-3xl font-bold text-gray-900" id="total-subscribers">-</p>
                        <p class="text-sm text-green-600 mt-1" id="subscriber-growth">-</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Open Rate</p>
                        <p class="text-3xl font-bold text-gray-900" id="open-rate">-</p>
                        <p class="text-sm text-gray-500 mt-1">Industry avg: 21.3%</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-envelope-open text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Click Rate</p>
                        <p class="text-3xl font-bold text-gray-900" id="click-rate">-</p>
                        <p class="text-sm text-gray-500 mt-1">Industry avg: 2.6%</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-mouse-pointer text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Emails Sent</p>
                        <p class="text-3xl font-bold text-gray-900" id="emails-sent">-</p>
                        <p class="text-sm text-gray-500 mt-1" id="last-sent">-</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-paper-plane text-orange-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Subscriber Growth Chart -->
            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Subscriber Growth</h3>
                <div id="subscriber-chart" class="h-64 flex items-center justify-center">
                    <div class="text-center text-gray-500">
                        <i class="fas fa-chart-line text-4xl mb-2"></i>
                        <p>Subscriber growth over time</p>
                        <div id="growth-bars" class="flex items-end gap-2 h-40 mt-4"></div>
                    </div>
                </div>
            </div>

            <!-- Email Performance Chart -->
            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Email Performance by Issue</h3>
                <div id="performance-chart" class="h-64 overflow-y-auto">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-white">
                            <tr class="text-left text-gray-500">
                                <th class="pb-2">Issue</th>
                                <th class="pb-2">Opens</th>
                                <th class="pb-2">Clicks</th>
                                <th class="pb-2">Unsubs</th>
                            </tr>
                        </thead>
                        <tbody id="performance-table">
                            <tr>
                                <td colspan="4" class="py-8 text-center text-gray-400">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-xl border border-gray-200 p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Subscriber Activity</h3>
            <div id="recent-activity" class="space-y-3">
                <p class="text-gray-400 text-center py-8">Loading recent activity...</p>
            </div>
        </div>

        <!-- A/B Test Results -->
        <div class="bg-white rounded-xl border border-gray-200 p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">A/B Test Results</h3>
            <div id="ab-tests" class="space-y-4">
                <p class="text-gray-400 text-center py-8">Loading A/B test data...</p>
            </div>
        </div>

        <!-- Engagement Heatmap -->
        <div class="bg-white rounded-xl border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Best Send Times (Opens by Day/Hour)</h3>
            <div id="heatmap" class="overflow-x-auto">
                <div class="grid grid-cols-8 gap-1 min-w-[600px]">
                    <div class="text-xs text-gray-500"></div>
                    <div class="text-xs text-gray-500 text-center">Mon</div>
                    <div class="text-xs text-gray-500 text-center">Tue</div>
                    <div class="text-xs text-gray-500 text-center">Wed</div>
                    <div class="text-xs text-gray-500 text-center">Thu</div>
                    <div class="text-xs text-gray-500 text-center">Fri</div>
                    <div class="text-xs text-gray-500 text-center">Sat</div>
                    <div class="text-xs text-gray-500 text-center">Sun</div>
                    <!-- Hours will be populated by JS -->
                </div>
                <div id="heatmap-grid" class="mt-2"></div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

        // Initialize with placeholder data for demo
        let analyticsData = {
            totalSubscribers: 0,
            newSubscribers: 0,
            openRate: 0,
            clickRate: 0,
            emailsSent: 0,
            lastSent: null,
            recentActivity: [],
            issuePerformance: [],
            abTests: []
        };

        async function refreshData() {
            const period = document.getElementById('period-select').value;

            // In production, this would fetch from Supabase
            // For now, show demo data structure

            try {
                // Simulated API calls
                await loadSubscriberStats(period);
                await loadEmailPerformance(period);
                await loadRecentActivity();
                await loadABTests();

                updateUI();
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function loadSubscriberStats(period) {
            // Would query: SELECT COUNT(*) FROM newsletter_subscribers WHERE status = 'active'
            // For demo:
            analyticsData.totalSubscribers = 247;
            analyticsData.newSubscribers = 23;
            analyticsData.openRate = 34.2;
            analyticsData.clickRate = 8.7;
            analyticsData.emailsSent = 26;
            analyticsData.lastSent = new Date(Date.now() - 2 * 24 * 60 * 60 * 1000);
        }

        async function loadEmailPerformance(period) {
            // Would query broadcast and engagement tables
            analyticsData.issuePerformance = [
                { issue: '#26', subject: 'Project Status Dashboard', opens: 89, clicks: 34, unsubs: 1 },
                { issue: '#25', subject: 'Client Retention Engine', opens: 92, clicks: 41, unsubs: 0 },
                { issue: '#24', subject: 'Sales Pipeline Automator', opens: 85, clicks: 29, unsubs: 2 },
                { issue: '#23', subject: 'Competitor Intelligence', opens: 88, clicks: 37, unsubs: 1 },
                { issue: '#22', subject: 'Knowledge Base Curation', opens: 79, clicks: 25, unsubs: 1 },
            ];
        }

        async function loadRecentActivity() {
            analyticsData.recentActivity = [
                { type: 'subscribe', email: 'john.d***@gmail.com', time: '2 hours ago', source: 'Landing page' },
                { type: 'open', email: 'sarah.m***@company.com', time: '4 hours ago', issue: '#26' },
                { type: 'click', email: 'mike.t***@startup.io', time: '5 hours ago', link: 'Recipe #95 download' },
                { type: 'subscribe', email: 'lisa.w***@corp.com', time: '8 hours ago', source: 'Quiz results' },
                { type: 'open', email: 'alex.b***@agency.co', time: '12 hours ago', issue: '#26' },
            ];
        }

        async function loadABTests() {
            analyticsData.abTests = [
                {
                    name: 'Issue #26 Subject Line',
                    status: 'completed',
                    variantA: { name: 'Version A', subject: 'Know exactly where every project stands', opens: 34.2 },
                    variantB: { name: 'Version B', subject: 'Your 30-second project status check', opens: 31.8 },
                    winner: 'A',
                    confidence: 94
                },
                {
                    name: 'CTA Button Color',
                    status: 'running',
                    variantA: { name: 'Blue', ctr: 8.4 },
                    variantB: { name: 'Green', ctr: 9.1 },
                    winner: null,
                    confidence: 72
                }
            ];
        }

        function updateUI() {
            // Update KPIs
            document.getElementById('total-subscribers').textContent = analyticsData.totalSubscribers.toLocaleString();
            document.getElementById('subscriber-growth').textContent = `+${analyticsData.newSubscribers} this period`;
            document.getElementById('open-rate').textContent = `${analyticsData.openRate}%`;
            document.getElementById('click-rate').textContent = `${analyticsData.clickRate}%`;
            document.getElementById('emails-sent').textContent = analyticsData.emailsSent;
            document.getElementById('last-sent').textContent = analyticsData.lastSent ?
                `Last: ${analyticsData.lastSent.toLocaleDateString()}` : '-';

            // Update performance table
            const tableBody = document.getElementById('performance-table');
            tableBody.innerHTML = analyticsData.issuePerformance.map(p => `
                <tr class="border-t border-gray-100">
                    <td class="py-3">
                        <span class="font-medium text-gray-900">${p.issue}</span>
                        <p class="text-xs text-gray-500 truncate max-w-[200px]">${p.subject}</p>
                    </td>
                    <td class="py-3">
                        <span class="text-green-600">${p.opens}%</span>
                    </td>
                    <td class="py-3">
                        <span class="text-blue-600">${p.clicks}%</span>
                    </td>
                    <td class="py-3">
                        <span class="${p.unsubs > 0 ? 'text-red-500' : 'text-gray-400'}">${p.unsubs}</span>
                    </td>
                </tr>
            `).join('');

            // Update recent activity
            const activityContainer = document.getElementById('recent-activity');
            const icons = {
                subscribe: '<i class="fas fa-user-plus text-green-600"></i>',
                open: '<i class="fas fa-envelope-open text-blue-600"></i>',
                click: '<i class="fas fa-mouse-pointer text-purple-600"></i>',
                unsubscribe: '<i class="fas fa-user-minus text-red-600"></i>'
            };
            activityContainer.innerHTML = analyticsData.recentActivity.map(a => `
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <div class="w-8 h-8 flex items-center justify-center">${icons[a.type]}</div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-900">${a.email}</p>
                        <p class="text-xs text-gray-500">${a.type === 'subscribe' ? `Subscribed via ${a.source}` :
                            a.type === 'open' ? `Opened ${a.issue}` :
                            a.type === 'click' ? `Clicked: ${a.link}` : ''}</p>
                    </div>
                    <span class="text-xs text-gray-400">${a.time}</span>
                </div>
            `).join('');

            // Update A/B tests
            const abContainer = document.getElementById('ab-tests');
            abContainer.innerHTML = analyticsData.abTests.map(t => `
                <div class="p-4 border border-gray-200 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-medium text-gray-900">${t.name}</h4>
                        <span class="px-2 py-1 text-xs rounded-full ${t.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                            ${t.status === 'completed' ? 'Completed' : 'Running'}
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 bg-gray-50 rounded-lg ${t.winner === 'A' ? 'ring-2 ring-green-500' : ''}">
                            <p class="text-sm font-medium">${t.variantA.name}</p>
                            <p class="text-xs text-gray-500">${t.variantA.subject || ''}</p>
                            <p class="text-lg font-bold mt-1">${t.variantA.opens || t.variantA.ctr}%</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg ${t.winner === 'B' ? 'ring-2 ring-green-500' : ''}">
                            <p class="text-sm font-medium">${t.variantB.name}</p>
                            <p class="text-xs text-gray-500">${t.variantB.subject || ''}</p>
                            <p class="text-lg font-bold mt-1">${t.variantB.opens || t.variantB.ctr}%</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        ${t.winner ? `Winner: Variant ${t.winner}` : 'No winner yet'} | Confidence: ${t.confidence}%
                    </p>
                </div>
            `).join('');

            // Generate heatmap
            generateHeatmap();
        }

        function generateHeatmap() {
            const grid = document.getElementById('heatmap-grid');
            const hours = [6, 8, 10, 12, 14, 16, 18, 20];
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            // Simulated engagement data (higher = more opens)
            const data = {
                '6-Mon': 15, '6-Tue': 20, '6-Wed': 18, '6-Thu': 22, '6-Fri': 16, '6-Sat': 8, '6-Sun': 5,
                '8-Mon': 45, '8-Tue': 52, '8-Wed': 48, '8-Thu': 55, '8-Fri': 42, '8-Sat': 15, '8-Sun': 10,
                '10-Mon': 38, '10-Tue': 42, '10-Wed': 40, '10-Thu': 45, '10-Fri': 35, '10-Sat': 20, '10-Sun': 15,
                '12-Mon': 30, '12-Tue': 35, '12-Wed': 32, '12-Thu': 38, '12-Fri': 28, '12-Sat': 18, '12-Sun': 12,
                '14-Mon': 25, '14-Tue': 30, '14-Wed': 28, '14-Thu': 32, '14-Fri': 22, '14-Sat': 12, '14-Sun': 8,
                '16-Mon': 35, '16-Tue': 40, '16-Wed': 38, '16-Thu': 42, '16-Fri': 30, '16-Sat': 10, '16-Sun': 6,
                '18-Mon': 28, '18-Tue': 32, '18-Wed': 30, '18-Thu': 35, '18-Fri': 25, '18-Sat': 8, '18-Sun': 5,
                '20-Mon': 18, '20-Tue': 22, '20-Wed': 20, '20-Thu': 25, '20-Fri': 15, '20-Sat': 5, '20-Sun': 3,
            };

            let html = '';
            hours.forEach(hour => {
                html += `<div class="grid grid-cols-8 gap-1">
                    <div class="text-xs text-gray-500 pr-2 text-right">${hour}:00</div>`;
                days.forEach(day => {
                    const value = data[`${hour}-${day}`] || 0;
                    const intensity = Math.min(value / 55, 1);
                    const bgColor = intensity > 0.7 ? 'bg-green-500' :
                                   intensity > 0.4 ? 'bg-green-300' :
                                   intensity > 0.2 ? 'bg-green-100' : 'bg-gray-100';
                    html += `<div class="h-6 ${bgColor} rounded text-xs flex items-center justify-center text-white font-medium" title="${day} ${hour}:00 - ${value}% opens">
                        ${intensity > 0.4 ? value : ''}
                    </div>`;
                });
                html += '</div>';
            });
            grid.innerHTML = html;
        }

        // Initial load
        refreshData();
    </script>
</body>
</html>
